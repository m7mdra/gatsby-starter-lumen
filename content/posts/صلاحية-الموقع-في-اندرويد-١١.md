---
template: post
title: صلاحية موقع الخلفية في اندرويد ١١
slug: android-11-background-permission
socialImage: https://www.maxpixel.net/static/photo/1x/Programming-Coding-Photoshop-Web-Php-Symbol-Code-3647303.jpg
draft: false
date: 2020-11-28T15:49:16.519Z
description: تغيير كيفية طلب صلاحية الموقع في اندرويد 11
category: عام
tags: [اندرويد,برمجة,صلاحيات]
---
قبل التغييرات الجديدة على نظام Android مع الإصدار 11 ، كان طلب الإذن لكل من الخلفية(Background) والمقدمة(Foreground) لحالات التطبيق هو نفس الشيئ ، فقط اطلب إذنًا واحدًا وكان كل شيء بسيطًا وسهلاً ، ولكن ليس بعد الآن.

![](/media/location_permission_old.webp)

## التغييرات الجديدة

بدءًا من `Android 11`  لكي يتلقى تطبيقك موقع الخلفية ، يجب عليك طلب إذن جديد `android.permission.ACCESS_BACKGROUND_LOCATION` مباشرة بعد أن تطلب الأذونات العادية `android.permission.ACCESS_COARSE_LOCATION` أو `android.permission.ACCESS_FINE_LOCATION` أو كليهما وسيستمر كل شيء في العمل كما كان من قبل.

تذكر اذا لم تقم بطلب هذه الصلاحيات بالطريقة المذكورة اعلاه فلن يكون هنالك استجابة مثل ان تطلب صلاحية `android.permission.ACCESS_BACKGROUND_LOCATION`  قبل `android.permission.ACCESS_COARSE_LOCATION` أو `android.permission.ACCESS_FINE_LOCATION`

## متى يجب أن تطلب هذا الإذن؟
بشكل عام عند وجود أي ميزة في التطبيق تتطلب الوصول إلى الموقع أثناء التواجد في الخلفية ، فإليك بعض حالات الاستخدام التي صادفتها أثناء العمل:
  - عندما تريد تشغيل Foreground service من الخلفية كمثال 
  
  عندما تريد تشغيل تتبع الوقع في الخليفة عندي يتنهي اعادة تشغيل الجهاز (booting) فعندها يجب عليك طلب هذه الصلاحية لانه النظام 
  - الوظائف المجدولة التي تستخدم الموقع (وظائف عامل ، مدير إنذار .. إلخ).

## مثال:
سيكون لدينا تطبيق بسيط يحتوي على زر واحد ، وسيطلب إذنًا عاديًا (`ACCESS_COARSE_LOCATION` ، `ACCESS_FINE_LOCATION`) و `ACCESS_BACKGROUND_LOCATION` على التوالي

### هيا لنبدأ
ابدأ أولاً بإضافة الأذونات في ملف `AndroidManifest.xml`

<div dir="ltr">

```xml
<xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.application.example">
 <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"
 />
<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" 
/>
<uses-permission android:name="android.permission.ACCESS_BACKGROUND_LOCATION" 
/>
  <application
    ...
```
</div>

الان لنقم بطلب الصلاحية ل `ACCESS_COARSE_LOCATION` و `ACCESS_FINE_LOCATION`

<div dir="ltr">

```kotlin
override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        permissionButton.setOnClickListener { 
          
            requestLocationPermission()
        }
    }
```

</div>

وهنا حيث يحدث كل شيئ

<div dir="ltr">

```kotlin
   private fun requestBackgroundPermission() {
        //تحقق اذا كان لم يكن لدى المستخدم صلاحية
        if (isLocationPermissionNotGranted()) {
           // تحقق ما اذا كان المستخدم قد رفض الصلاحية من قبل
            if (shouldShowRational()) {
              //اظهار صندوق يبين للمستخدم لماذا هذه الصلاحية مهمة لكي تعمل الخاصية المعينة
               showRationalDialog()
            } else {
                // طلب الصلاحية
                requestLocationPermission()
            }
        } else {
            //تم منح الاذن مسبقا
            //تحقق اذا كان نسخة الجهاز هي اندرويد ١١
            if (isAndroid11()) {
              //تحقق اذا لم يتم منح صلاحية موقع الخلقية 
                if (isBackgroundLocationPermissionNotGranted()) 
                // قم بطلب الصلاحية
                    requestBackgroundLocation()
                } else {
                  // تم منح الصلاحية
                  // قم بفعل اي شيئ بعدا ذلك
                }
            } else {
                //  النسخة اقل من ١١ , لا حاجه لطلب الصلاحية 
            }
        }
    }
```
</div>
والان بعد ان يتم تنفيذ هذا الكود بعد الضغط على الزر سوف يظهر للمستخدم صندوق فيها خياران رفض او قبول
سوف نقوم بالتحقق من هذا الحدث
<div dir="ltr">

```kotlin 
    override fun onRequestPermissionsResult(
        requestCode: Int,
        permissions: Array<out String>,
        grantResults: IntArray
    ) {
        super.onRequestPermissionsResult(requestCode, permissions, grantResults)
        if(requestCode == REQUEST_CODE_LOCATION_PERMISSION){
            if(grantResults[0]==PackageManager.PERMISSION_GRANTED){
                //تم منح الصلاحية
                //الان لنقم بطلب صلاحية الموقع من الخلفية
                requestBackgroundLocation()
            }else{
                //قام المستخدم برفض الصلاحية, يمكن اظهار رسالة توضح لماذا هذه الصلاحية مهمة
            }
        }
        if(requestCode == REQUEST_CODE_BACKGROUND_LOCATION_PERMISSION){
            if(grantResults[0]==PackageManager.PERMISSION_GRANTED){
                //يتم منح إذن موقع الخلفية
            }else{
                //قام المستخدم برفض الصلاحية, يمكن اظهار رسالة توضح لماذا هذه الصلاحية مهمة
            }
        }
    }
```
</div>

`REQUEST_CODE_BACKGROUND_LOCATION_PERMISSION` و `REQUEST_CODE_LOCATION_PERMISSION` متغيرات ثابته(static final) يتم تمريرها عند طلب الصلاحية 

وهذا كل شيء ، والآن سنقوم بتشغيل تطبيقنا ومعرفة ما إذا كان يعمل

![](/media/1.webp)
![](/media/2.webp)
![](/media/3.webp)


سوف اقوم لاحقا باضافة السورس كود

النهاية

